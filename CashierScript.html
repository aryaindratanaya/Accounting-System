<script>
  // VARIABLES
  let drinks = [];
  let orders = [];
  const ordersKeys = [];

  // PREPARATION
  resetPage();
  function resetPage() {
    $("#inputDateTime").val(
      new Date().toJSON().slice(0, 11) +
        ("0" + new Date().getHours()).slice(-2) +
        ":" +
        ("0" + new Date().getMinutes()).slice(-2)
    );

    google.script.run.withSuccessHandler(getDrinksHandler).getDrinks();
  }

  // ON-PROCESS
  // Fill the inputPrice
  $("#inputFnB").on("change", function () {
    const sltFnB = this.value;
    drinks.forEach((item) => {
      if (item[0] === sltFnB) {
        $("#inputPrice").val(item[1]);
      }
    });
  });
  // Add order(s) to orders
  function addOrder() {
    const sltFnB = $("#inputFnB").val();
    const sltPrice = Number($("#inputPrice").val());
    const sltQuantity = Number($("#inputQuantity").val());

    if (orders.length === 0) {
      orders.push({
        [sltFnB]: { quantity: sltQuantity, price: sltQuantity * sltPrice },
      });
      ordersKeys.push(Object.keys(orders[0])[0]);
    } else {
      if (!ordersKeys.includes(sltFnB)) {
        orders.push({
          [sltFnB]: { quantity: sltQuantity, price: sltQuantity * sltPrice },
        });
        ordersKeys.push(Object.keys(orders[orders.length - 1])[0]);
      } else {
        orders[ordersKeys.indexOf(sltFnB)] = {
          [sltFnB]: {
            quantity:
              orders[ordersKeys.indexOf(sltFnB)][sltFnB].quantity + sltQuantity,
            price:
              orders[ordersKeys.indexOf(sltFnB)][sltFnB].price +
              sltQuantity * sltPrice,
          },
        };
      }
    }
    fillTable();
  }
  // Populate orders to order table
  function fillTable() {
    $("tbody").empty();
    let orderEntries = [];

    orders.forEach((order, i) => {
      const minusIcon =
        '<button type="button" class="btn btn-warning" onClick="updateOrder(this)" id="mns-' +
        i +
        '">-</button>';
      const plusIcon =
        '<button type="button" class="btn btn-success" onClick="updateOrder(this)" id="pls-' +
        i +
        '">+</button>';
      const trashIcon =
        '<button type="button" class="btn btn-danger" onClick="updateOrder(this)" id="dlt-' +
        i +
        '"><i class="fa fa-trash" aria-hidden="true"></i></button>';
      const actions =
        '<div class="btn-group" role="group">' +
        minusIcon +
        trashIcon +
        plusIcon +
        "</div>";

      orderEntries.push(
        "<tr><td>" +
          (Number(i) + 1) +
          "</td><th scope='row'>" +
          Object.keys(order)[0] +
          "</th><td>" +
          order[Object.keys(order)[0]].quantity +
          "</td><td>" +
          order[Object.keys(order)[0]].price +
          "</td><td style='width: 30px'>" +
          actions +
          "</td></tr>"
      );
    });

    $("tbody").append(orderEntries.join(""));
  }
  // Update an order from order table
  function updateOrder(element) {
    const action = element.id.split("-")[0];
    const i = element.id.split("-")[1];
    const orderKey = ordersKeys[i];
    const prevQuantity = orders[i][orderKey].quantity;
    const prevPrice = orders[i][orderKey].price;

    switch (action) {
      case "dlt":
        orders.splice(i, 1);
        ordersKeys.splice(i, 1);
        break;
      case "mns":
        if (!(prevQuantity === 1)) {
          orders[i][orderKey].quantity = prevQuantity - 1;
          orders[i][orderKey].price = prevPrice - prevPrice / prevQuantity;
        } else {
          orders.splice(i, 1);
          ordersKeys.splice(i, 1);
        }
        break;
      case "pls":
        orders[i][orderKey].quantity = prevQuantity + 1;
        orders[i][orderKey].price = prevPrice + prevPrice / prevQuantity;
        break;
    }
    fillTable();
  }

  // HANDLERS
  function getDrinksHandler(params) {
    drinks = params;
    $("#inputPrice").val(drinks[0][1]);
  }
</script>
